<link rel="import" href="uvalib-directory.html">

<dom-module id="uvalib-team-dir">
  <template>

  </template>

  <script>
    let uvalibTeamDirTemplate;

    /**
     * `uvalib-team-dir`
     * UVA Library page layout component
     *
     * @customElement
     * @polymer
     * @demo demo/staff-dir.html
     * @demo demo/team-staff.html
     */
    class UvalibTeamDir extends UvalibDirectory {
      static get is() { return 'uvalib-team-dir'; }
      static get properties() {
        return Object.assign(super.properties,
            {
              area: {
                type: String,
                value: null
              },
              _controls: {
                type: Boolean,
                computed: '_showControls(team)'
              },
              searchPlaceholder: {
                type: String,
                value: "Search for Library Teams"
              },
              columns: {
                type: Array,
                computed: "_makeColumns(area)"
              }
            });
      }
      static get template() {
        if (!uvalibTeamDirTemplate) {
            // Retrieve this element's dom-module template
            uvalibTeamDirTemplate = Polymer.DomModule.import(this.is, 'template');
            // Clone the contents of the superclass template
            let superTemplateContents = UvalibDirectory.template.content.cloneNode(true);
            // Insert the superclass contents
            uvalibTeamDirTemplate.content.insertBefore(superTemplateContents,null);
        }
        return uvalibTeamDirTemplate;
      }

      _makeColumns(area){
        var cols = [];
        cols.push(
          {
            title:"Team Title",
            sortable:{dir:'asc',path:'title'},
            width:"20%",
            mkCell:function(item,that){
              return `<a href="/teams/${item.uuid}">${that._getTeamName(item.uuid)}</p>`;
            }
          });
        if (!area) cols.push(
          {
            title:"Area",
            width:"20%",
//            sortable:{path:''},
            mkCell:function(item,that){
              return item.area? `<a href="/areas/${item.area}">${that._getAreaName(item.area)}</p>`:"";
            }
          });
        cols.push(
          {
            title:"Lead",
            width:"20%",
            mkCell:function(item,that){
              return item.manager? `<a href="/staff/${that._getPersonID(item.manager)}">${that._getPersonName(item.manager)}</a>`:"";
            }
          });
        return cols;
      }

      _teamsChanged(){
        this._filterRows(this._teams);
      }

      _sortData(teams){
        if(teams) {
          var tmp = teams.sort(function(a,b){
            return (a.title.toLowerCase() < b.title.toLowerCase());
          });
          this.set('_data', tmp );
        }
      }

      _filter(query){
        if (query) {
          query = query.toLowerCase().trim().replace(/ +(?= )/g,'');
          return function(s) {
            return (s.title.toLowerCase().indexOf(query) != -1);
          }.bind(this);
        } else if (this.area) {
          return function(t){
            return t.area === this.area;
          }.bind(this);
        } else {
          return null;
        }
      }

      _makeTeams(_libraries,_people,_teams,_areas){
        if (_libraries && _people && _teams && _areas) {
          if (!this._cachedPeople) {
            if (_libraries && _people && _teams && _areas) {
              var people = {};
              _people.forEach(p=>{
                if (p.computingId) {
                  people[p.computingId] = p;
                }
              });
              // assign teams to people
              _teams.forEach(t=>{
                if (t.groupMembers)
                  t.groupMembers.forEach(p=>{
                    if (people[p]) {
                      if (!people[p]['teams']) people[p]['teams'] = [t.uuid];
                      else people[p]['teams'].push(t.uuid);
                    }
                  });
              });
              this._cachedPeople = Object.values(people);
              return this._cachedPeople;
            }
            return null;
          } else {
            return this._cachedPeople;
          }
        }
      }

      _getName(person){
          if (person) return (person.displayName)?
            person.displayName:
            person.fullName;
      }

      _getEmail(person){
        return (person.email)?
          person.email:
          person.computingId+"@virginia.edu"
      }

      /* Don't show search if team is specified */
      _showControls(team){
        return !(team);
      }
    }

    window.customElements.define(UvalibTeamDir.is, UvalibTeamDir);
  </script>
</dom-module>
