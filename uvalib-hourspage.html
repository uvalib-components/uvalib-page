<link rel="import" href="../uvalib-theme/uvalib-ui-element.html">
<link rel="import" href="../uvalib-theme/uvalib-theme.html">
<link rel="import" href="../uvalib-theme/uvalib-page-style.html">
<link rel="import" href="../uvalib-theme/uvalib-hourspage-style.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="" href="../marked-element/marked-element.html">
<link rel="import" href="../uva-models/uva-library.html">
<link rel="import" href="../uva-models/uva-library-hours.html">
<link rel="import" href="../uva-helper-libs/moment-timezone.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../uvalib-theme/uvalib-icons.html">
<link rel="import" href="../uva-accordion/uva-accordion.html">

<dom-module id="uvalib-hourspage">
  <template>
    <custom-style>
      <style include="uvalib-theme uvalib-page-style uvalib-hourspage-style iron-flex-factors">
        :host {
          display: block;
        }
        [hidden] {
          display: none;
        }
        paper-card {
          max-width: 24em;
          --paper-card-header-image: {
            max-height: 300px;
          }
        }
      </style>
    </custom-style>

    <uva-library filter="libcalID" items="{{_libraries}}" sort-by="shortTitle"></uva-library>
    <uva-library-hours id="hours" start="[[_start]]" end="[[_end]]" times="{{_times}}"></uva-library-hours>

    <template is="dom-if" if="[[largeScreen]]">
        <div class="horizontal layout end-justified wrap">
          <paper-button raised>Directions & Maps</paper-button>
          <paper-button raised>Find a Study Space</paper-button>
          <paper-button raised>Room Reservations</paper-button>
        </div>

        <table>
          <colgroup>
            <col />
            <tempplate is="dom-repeat" items="[[_days]]">
              <col shady$="[[item.today]]" />
            </tempplate>
          </colgroup>
          <tr>
            <td>
              <paper-button raised disabled$="[[!page]]" on-tap="_setPageZero">Today</paper-button>
              <paper-button raised hidden$="[[!page]]" on-tap="_pageDown">Previous</iron-icon></paper-button>
              <paper-button raised on-tap="_pageUp">Next</iron-icon></paper-button>

              <paper-button raised>Expand All</paper-button>
            </td>
            <template is="dom-repeat" items="[[_days]]">
              <th>[[item.date]]<br />[[item.title]]</th>
            </template>
          </tr>
          <template is="dom-repeat" items="[[_libraries]]" as="library">
            <tr>
              <td>[[library.title]]</td>
              <template is="dom-repeat" items="[[_days]]" as="day">
                <td>[[_getOpenRange(library.libcalID,day.id,_times)]]</td>
              </template>
            </tr>
          </template>
        </table>
    </template>
    <template is="dom-if" if="[[!largeScreen]]">
      <div class="layout vertical">
        <template is="dom-repeat" items="[[_libraries]]" as="library">
          <template is="dom-if" if="[[library.libcalID]]">
            <paper-card id="[[library.id]]-card" heading="[[library.title]]" on-tap="_cardTap">
                <div class="card-content">
                  <div class="current-times" closed$="[[_isClosed(library.libcalID,_times,_refresh)]]">[[_getRange(library.libcalID,_times,_refresh)]]</div>
                  <div class="extended-info">
                    <div>
                      <paper-button raised disabled$="[[!page]]" on-tap="_setPageZero">Today</paper-button>
                      <paper-button raised hidden$="[[!page]]" on-tap="_pageDown">Previous</iron-icon></paper-button>
                      <paper-button raised on-tap="_pageUp">Next</iron-icon></paper-button>
                    </div>
                    <div class="days">
                      <template is="dom-repeat" items="[[_days]]" as="day">
                        <div class="date">
                          [[day.title]] [[day.date]]
                        </div>
                        <div class="hours">
                          [[_getOpenRange(library.libcalID,day.id,_times)]]
                        </div>
                      </template>
                    </div>
                    <div>
                      <paper-button raised id="map-[[library.id]]" on-tap="_mapIt">Map it</paper-button>
                    </div>
                  </div>
                </div>
            </paper-card>
          </template>
        </template>
      </div>
    </template>
    <div class="horizontal layout center-justified wrap">
      <a href="#darden" tabindex="-1"><paper-button raised>Darden Library</paper-button></a>
      <a href="#health-sciences" tabindex="-1"><paper-button raised>Health Sciences Library</paper-button></a>
      <a href="#jag" tabindex="-1"><paper-button raised>JAG School Library</paper-button></a>
      <a href="#law" tabindex="-1"><paper-button raised>Law Library</paper-button></a>
    </div>

    <div class="shady layout horizontal wrap center-justified">
      <template is="dom-repeat" items="[[_libraries]]" as="lib">
        <paper-card heading$="[[lib.title]]" image$="[[lib.mainImage.url]]">
          <marked-element markdown="[[lib.body]]">
            <div slot="markdown-html"></div>
          </marked-element>
        </paper-card>
      </template>
    </div>

  </template>

  <script>
    /**
     * `uvalib-hourspage`
     * UVA Library page layout component
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvalibHourspage extends UvalibUiElement {
      static get is() { return 'uvalib-hourspage'; }
      static get properties() {
        return Object.assign(super.properties,{
          _libraries: Array,
          page: {
            type: Number,
            value: 0
          },
          count: {
            type: Number,
            value: 7
          },
          _start: {
            type: Object,
            computed: '_getStartDate(page,count)',
            notify: true
          },
          _end: {
            type: Object,
            computed: '_getEndDate(page,count)',
            notify: true
          },
          _days: {
            type: Array,
            computed: '_getDays(_start,_end)'
          },
          _times: Object,
          /** Used to force a refresh - incremented via a setInterval */
          _refresh: {
            type: Number,
            value: 0
          }
        });
      }
      //Concat the this elements template with the parents
      static get template() {
        var parentTemplate = UvalibUiElement.template.cloneNode(true);
        var childTemplate = Polymer.DomModule.import('uvalib-hourspage', 'template');
        parentTemplate.content.insertBefore(childTemplate.content,null);
        return parentTemplate;
      }
      connectedCallback(){
        super.connectedCallback();
        // update the open/closed and range every 5 minutes
        this._intervalId = setInterval(function(){
              this._refresh++;  // the change forces the dom-bound method to evaluate
            }.bind(this), 300000);
      }
      connectedCallback(){
        super.connectedCallback();
        // update the open/closed and range every 5 minutes
        this._intervalId = setInterval(function(){
              this._refresh++;  // the change forces the dom-bound method to evaluate
            }.bind(this), 300000);
      }
      disconnectedCallback(){
        super.disconnectedCallback();
        clearInterval(this._intervalId);
      }
      _cardTap(e){
        var foo="bar";
        console.log(e);
      }
      _hasLibCal(lib){
        return !!(lib.libcalID);
      }
      _isClosed(calID){
        return !this.$.hours.isOpenNow(calID);
      }
      _getRange(calID){
        return this.$.hours.getHoursRange(calID);
      }
      _getOpenRange(lid,d){
        if (this._times && this._times[lid] && this._times[lid][d])
          return this._times[lid][d].rendered;
      }
      _pageUp(){
        this.page++;
      }
      _pageDown(){
        this.page--;
      }
      _setPageZero(){
        this.page=0;
      }
      _getStartDate(page,count){
        return moment().add(page*count,'days');
      }
      _getEndDate(page,count){
        return moment().add(page*count+count,'days');
      }
      _getDays(start, end) {
        var s = moment(start),
            range = [];
        while (s < end) {
          var isToday = s.isSame(new Date(),'day'),
              sf = s.tz('America/New_York');
          range.push({
            id:sf.format('YYYY-MM-DD'),
            date:sf.format('MMM D'),
            title:(isToday)?'Today':sf.format('dddd'),
            today:isToday});
          s.add(1,'days');
        }
        return range;
      }
    }

    window.customElements.define(UvalibHourspage.is, UvalibHourspage);
  </script>
</dom-module>
