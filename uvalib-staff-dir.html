<link rel="import" href="uvalib-directory.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../uvalib-theme/uvalib-icons.html">
<link rel="import" href="../uva-helper-libs/polyfills/string.includes.html">
<link rel="import" href="../uva-helper-libs/polyfills/array.find.html">

<dom-module id="uvalib-staff-dir">
  <template>

<!--
      <template is="dom-if" if="[[!smallScreen]]" restamp>
          <vaadin-grid height-by-rows="[[largeScreen]]" theme="no-border row-stripes wrap-cell-content" aria-label="Staff directory listing" items="[[people]]">
            <vaadin-grid-column width="20%">
              <template class="header"><vaadin-grid-sorter direction="asc" path="fullName"><div class="title-text">Name</div></vaadin-grid-sorter></template>
              <template><strong><a href="/staff/[[item.computingId]]">[[_getName(item)]]</p></strong></template>
            </vaadin-grid-column>
            <vaadin-grid-column width="20%">
              <template class="header"><div class="title-text">Title</div></template>
              <template>[[item.jobTitle]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column width="20%">
              <template class="header"><div class="team-text">Team</div></template>
              <template>
                <template is="dom-repeat" items="[[item.teams]]">
                  <a href="/teams/[[item]]">[[_getTeamName(item)]]</a><br />
                </template>
              </template>
            </vaadin-grid-column>
            <vaadin-grid-column width="20%">
              <template class="header"><div class="team-text">Contact</div></template>
              <template>
                <div class="email"><a href="mailto:[[_getEmail(item)]]">[[_getEmail(item)]]</a></div>
                <div class="phone" hidden$="[[!item.phone]]"><a href="tel:[[item.phone]]">[[item.phone]]</a></div>
              </template>
            </vaadin-grid-column>
            <vaadin-grid-column width="20%">
              <template class="header"><div class="team-text">Library</div></template>
              <template><a href="/hours#[[_getLibrarySlug(item.library)]]">[[_getLibraryName(item.library)]]</a></template>
            </vaadin-grid-column>

          </vaadin-grid>
      </template>
      <template is="dom-if" if="[[smallScreen]]" restamp>
        <template is="dom-repeat" items="[[_filterSort(people,_query)]]">
          <paper-card heading="[[_getName(item)]]">
            <h2>[[item.jobTitle]]</h2>
            <div class="teams" hidden$="[[!item.teams]]">
              <template is="dom-repeat" items="[[item.teams]]">
                <a href="/teams/[[item]]">[[_getTeamName(item)]]</a><br />
              </template>
            </div>
            <div class="email"><a href="mailto:[[_getEmail(item)]]">[[_getEmail(item)]]</a></div>
            <div class="phone" hidden$="[[!item.phone]]"><a href="tel:[[item.phone]]">[[item.phone]]</a></div>
            <div class="library">
              <a href="/hours#[[_getLibrarySlug(item.library)]]">[[_getLibraryName(item.library)]]</a>
            </div>
          </paper-card>
        </template>
      </template>
-->
  </template>

  <script>
    let uvalibStaffDirTemplate;

    /**
     * `uvalib-staff-dir`
     * UVA Library page layout component
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvalibStaffDir extends UvalibDirectory {
      static get is() { return 'uvalib-staff-dir'; }
      static get properties() {
        return Object.assign(super.properties,
            {
              _data: {
                type: Array,
                value: function(){ return []; },
                notify: true
              },
            });
      }
      static get template() {
        if (!uvalibStaffDirTemplate) {
            // Retrieve this element's dom-module template
            uvalibStaffDirTemplate = Polymer.DomModule.import(this.is, 'template');
            // Clone the contents of the superclass template
            let superTemplateContents = UvalibDirectory.template.content.cloneNode(true);
            // Insert the superclass contents
            uvalibStaffDirTemplate.content.insertBefore(superTemplateContents,null);
        }
        return uvalibStaffDirTemplate;
      }
      _peopleChanged(){this._filterRows();}
      _filterRows() {
        //clone the pristine people listing so that we can come back from filters w/o reloading
        //ensure that people, teams, and libraries are loaded
        if (this._libraries && this._libraries.length > 0 && this._teams && this._people){
          var data = JSON.parse(JSON.stringify(this._people));
          this._sortData(this._filterData(data));
        } else {
          setTimeout(function(){this._filterRows()}.bind(this),500);
        }
      }

/*
      _sortData(data){
        var dir = this._sortDir;
        if(data) {
          data.sort(function(a,b){
            if (dir === "desc") {
              return a.title.toLowerCase().localeCompare(b.title.toLowerCase());
            } else {
              return b.title.toLowerCase().localeCompare(a.title.toLowerCase());
            }
          });
          this.set('_data', data );
        }
      }
      _filterSort(pep,query){
        if (pep) {
          var tmp = pep.sort(function(a,b){
            var alast = (a.lastName)? a.lastName:a.fullName;
            var blast = (b.lastName)? b.lastName:b.fullName;
            return (alast.toLowerCase() < blast.toLowerCase());
          });
          return tmp;
        }
      }
      _getEmail(person){
        return (person.email)?
          person.email:
          person.computingId+"@virginia.edu"
      }
      _getName(person){
          if (person) return (person.displayName)?
            person.displayName:
            person.fullName;
      }
      _makePeople(_libraries,_people,_teams,_query){
        if (!this._cachedPeople) {
          if (_libraries && _people && _teams) {
            var people = {};
            _people.forEach(p=>{
              if (p.computingId) {
                people[p.computingId] = p;
              }
            });
            // assign teams to people
            _teams.forEach(t=>{
              if (t.groupMembers)
                t.groupMembers.forEach(p=>{
                  if (people[p]) {
                    if (!people[p]['teams']) people[p]['teams'] = [t.uuid];
                    else people[p]['teams'].push(t.uuid);
                  }
                });
            });
            this._cachedPeople = Object.values(people);
            return this._cachedPeople;
          }
          return null;
        } else {
          return this._cachedPeople;
        }
      }
      _filter(_query,_list) {
        if (_query) {

        } else {
          return _query;
        }
      }
*/
    }

    window.customElements.define(UvalibStaffDir.is, UvalibStaffDir);
  </script>
</dom-module>
