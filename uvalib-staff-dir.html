<link rel="import" href="uvalib-directory.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../uvalib-theme/uvalib-icons.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../uva-helper-libs/polyfills/string.includes.html">
<link rel="import" href="../uva-helper-libs/polyfills/array.find.html">

<dom-module id="uvalib-staff-dir">
  <template>

      <div id="controls">
        <paper-input label="Search" value="{{_query}}">
          <div slot="prefix">
            <span class="uvalib-icon-search uva-padding-right"></span>
          </div>
        </paper-input>
      </div>

      <template is="dom-if" if="[[!smallScreen]]" restamp>
          <vaadin-grid height-by-rows="[[largeScreen]]" theme="no-border row-stripes wrap-cell-content" aria-label="Staff directory listing" items="[[people]]">
            <vaadin-grid-column width="20%">
              <template class="header"><vaadin-grid-sorter direction="asc" path="fullName"><div class="title-text">Name</div></vaadin-grid-sorter></template>
              <template><strong><a href="/staff/[[item.computingId]]">[[_getName(item)]]</p></strong></template>
            </vaadin-grid-column>
            <vaadin-grid-column width="20%">
              <template class="header"><div class="title-text">Title</div></template>
              <template>[[item.jobTitle]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column width="20%">
              <template class="header"><div class="team-text">Team</div></template>
              <template>
                <template is="dom-repeat" items="[[item.teams]]">
                  <a href="/teams/[[item]]">[[_getTeamName(item)]]</a><br />
                </template>
              </template>
            </vaadin-grid-column>
            <vaadin-grid-column width="20%">
              <template class="header"><div class="team-text">Contact</div></template>
              <template>
                <div class="email"><a href="mailto:[[_getEmail(item)]]">[[_getEmail(item)]]</a></div>
                <div class="phone" hidden$="[[!item.phone]]"><a href="tel:[[item.phone]]">[[item.phone]]</a></div>
              </template>
            </vaadin-grid-column>
            <vaadin-grid-column width="20%">
              <template class="header"><div class="team-text">Library</div></template>
              <template><a href="/hours#[[_getLibrarySlug(item.library)]]">[[_getLibraryName(item.library)]]</a></template>
            </vaadin-grid-column>

          </vaadin-grid>
      </template>
      <template is="dom-if" if="[[smallScreen]]" restamp>
        <template is="dom-repeat" items="[[_filterSort(people,_query)]]">
          <paper-card heading="[[_getName(item)]]">
            <h2>[[item.jobTitle]]</h2>
            <div class="teams" hidden$="[[!item.teams]]">
              <template is="dom-repeat" items="[[item.teams]]">
                <a href="/teams/[[item]]">[[_getTeamName(item)]]</a><br />
              </template>
            </div>
            <div class="email"><a href="mailto:[[_getEmail(item)]]">[[_getEmail(item)]]</a></div>
            <div class="phone" hidden$="[[!item.phone]]"><a href="tel:[[item.phone]]">[[item.phone]]</a></div>
            <div class="library">
              <a href="/hours#[[_getLibrarySlug(item.library)]]">[[_getLibraryName(item.library)]]</a>
            </div>
          </paper-card>
        </template>
      </template>

  </template>

  <script>
    let uvalibStaffDirTemplate;

    /**
     * `uvalib-staff-dir`
     * UVA Library page layout component
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvalibStaffDir extends UvalibDirectory {
      static get is() { return 'uvalib-staff-dir'; }
      static get properties() {
        return Object.assign(super.properties,
            {
              _libraries: {
                type: Array,
                notify: true,
              },
              _people: {
                type: Array,
                notify: true
              },
              _teams: {
                type: Array,
                notify: true
              },
              people: {
                type: Array,
                computed: '_makePeople(_libraries,_people,_teams,_query)'
              }
            });
      }
      static get template() {
        if (!uvalibStaffDirTemplate) {
            // Retrieve this element's dom-module template
            uvalibStaffDirTemplate = Polymer.DomModule.import(this.is, 'template');
            // Clone the contents of the superclass template
            let superTemplateContents = document.importNode(UvalibDirectory.template.content, true);
            // Insert the superclass contents
            uvalibStaffDirTemplate.content.insertBefore(superTemplateContents,null);
        }
        return uvalibStaffDirTemplate;
      }
      _filterSort(pep,query){
        if (pep) {
          var tmp = pep.sort(function(a,b){
            var alast = (a.lastName)? a.lastName:a.fullName;
            var blast = (b.lastName)? b.lastName:b.fullName;
            return (alast.toLowerCase() < blast.toLowerCase());
          });
          return tmp;
        }
      }
      _getEmail(person){
        return (person.email)?
          person.email:
          person.computingId+"@virginia.edu"
      }
      _getName(person){
          if (person) return (person.displayName)?
            person.displayName:
            person.fullName;
      }
      _getLibrarySlug(uuid){
        if (! this._libSlugs ) this._libSlugs = {}
        return this._getListValue(this._libraries,this._libSlugs,uuid,'slug');
      }
      _getLibraryName(uuid){
        if (! this._libNames ) this._libNames = {}
        return this._getListValue(this._libraries,this._libNames,uuid,'title');
      }
      _getTeamName(uuid){
        if (! this._teamNames ) this._teamNames = {}
        return this._getListValue(this._teams,this._teamNames,uuid,'title');
      }
      _getListValue(list,buffer,uuid,prop){
        if (list && uuid) {
          if (buffer[uuid]) return buffer[uuid];
          var item = list.find( item => item.uuid === uuid);
          if (item) {
            buffer[uuid] = item[prop];
            return item[prop];
          }
        }
      }
      _makePeople(_libraries,_people,_teams,_query){
        if (!this._cachedPeople) {
          if (_libraries && _people && _teams) {
            var people = {};
            _people.forEach(p=>{
              if (p.computingId) {
                people[p.computingId] = p;
              }
            });
            // assign teams to people
            _teams.forEach(t=>{
              if (t.groupMembers)
                t.groupMembers.forEach(p=>{
                  if (people[p]) {
                    if (!people[p]['teams']) people[p]['teams'] = [t.uuid];
                    else people[p]['teams'].push(t.uuid);
                  }
                });
            });
            this._cachedPeople = Object.values(people);
            return this._cachedPeople;
          }
          return null;
        } else {
          return this._cachedPeople;
        }
      }
      _filter(_query,_list) {
        if (_query) {

        } else {
          return _query;
        }
      }
    }

    window.customElements.define(UvalibStaffDir.is, UvalibStaffDir);
  </script>
</dom-module>
