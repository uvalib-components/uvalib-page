<link rel="import" href="../uvalib-theme/uvalib-ui-element.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../uvalib-theme/uvalib-icons.html">
<link rel="import" href="../uva-models/uva-library.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../uva-helper-libs/polyfills/string.includes.html">
<link rel="import" href="../uva-helper-libs/polyfills/array.find.html">
<link rel="import" href="../uvalib-theme/uvalib-theme.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../app-storage/app-localstorage/app-localstorage-document.html" />
<link rel="import" href="../vaadin-grid/vaadin-grid.html">
<link rel="import" href="../vaadin-grid/vaadin-grid-sorter.html">

<dom-module id="uvalib-staff-dir">
  <template>
    <custom-style>
      <style include="uvalib-theme">
        :host {
          display: block;
        }
        [hidden] {
          display: none;
        }
        #controls {
          padding-bottom: 20px;
        }

      </style>
    </custom-style>

    <div id="container">
      <div id="controls">
        <paper-input label="Search" value="{{_query}}">
          <div slot="prefix">
            <span class="uvalib-icon-search uva-padding-right"></span>
          </div>
        </paper-input>
      </div>

      <uva-library id="libs" last-response="{{_libraries}}"></uva-library>
      <uva-library path="people" id="people" last-response="{{_people}}"></uva-library>
      <uva-library path="teams" id="teams" last-response="{{_teams}}"></uva-library>

<template is="dom-if" if="[[!smallScreen]]" restamp>
      <vaadin-grid height-by-rows="[[largeScreen]]" theme="no-border row-stripes wrap-cell-content" aria-label="Staff directory listing" items="[[people]]">
        <vaadin-grid-column width="20%">
          <template class="header"><vaadin-grid-sorter direction="asc" path="fullName"><div class="title-text">Name</div></vaadin-grid-sorter></template>
          <template><strong><a href="/staff/[[item.computingId]]">[[_getName(item)]]</p></strong></template>
        </vaadin-grid-column>
        <vaadin-grid-column width="20%">
          <template class="header"><div class="title-text">Title</div></template>
          <template>[[item.jobTitle]]</template>
        </vaadin-grid-column>
        <vaadin-grid-column width="20%">
          <template class="header"><div class="team-text">Team</div></template>
          <template>
            <template is="dom-repeat" items="[[item.teams]]">
              [[_getTeamName(item)]]<br />
            </template>
          </template>
        </vaadin-grid-column>
        <vaadin-grid-column width="20%">
          <template class="header"><div class="team-text">Contact</div></template>
          <template>
            <div class="email"><a href="mailto:[[_getEmail(item)]]">[[_getEmail(item)]]</a></div>
            <div class="phone" hidden$="[[!item.phone]]"><a href="tel:[[item.phone]]">[[item.phone]]</a></div>
          </template>
        </vaadin-grid-column>
        <vaadin-grid-column width="20%">
          <template class="header"><div class="team-text">Library</div></template>
          <template>[[_getLibrary(item.library)]]</template>
        </vaadin-grid-column>

      </vaadin-grid>
</template>
<template is="dom-if" if="[[smallScreen]]" restamp>

</template>

    </div>
  </template>

  <script>
    /**
     * `uvalib-staff-dir`
     * UVA Library page layout component
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvalibStaffDir extends UvalibUiElement {
      static get is() { return 'uvalib-staff-dir'; }
      static get properties() {
        return Object.assign(super.properties,
            {
              _query: {
                type:String,
              },
              _libraries: {
                type: Array,
                notify: true,
              },
              _people: {
                type: Array,
                notify: true
              },
              _teams: {
                type: Array,
                notify: true
              },
              people: {
                type: Array,
                computed: '_makePeople(_libraries,_people,_teams,_query)'
              }
            });
      }
      //Concat the this elements template with the parents
      static get template() {
        var parentTemplate = UvalibUiElement.template.cloneNode(true);
        var childTemplate = Polymer.DomModule.import('uvalib-staff-dir', 'template');
        parentTemplate.content.insertBefore(childTemplate.content,null);
        return parentTemplate;
      }
      ready() {
        super.ready();
      }
      _getEmail(person){
        return (person.email)?
          person.email:
          person.computingId+"@virginia.edu"
      }
      _getName(person){
          if (person) return (person.displayName)?
            person.displayName:
            person.fullName;
      }
      _getLibrary(uuid){
        if (! this._libNames ) this._libNames = {}
        return this._getListName(this._libraries,this._libNames,uuid);
      }
      _getTeamName(uuid){
        if (! this._teamNames ) this._teamNames = {}
        return this._getListName(this._teams,this._teamNames,uuid);
      }
      _getListName(list,buffer,uuid){
        if (list && uuid) {
          if (buffer[uuid]) return buffer[uuid];
          var item = list.find( item => item.uuid === uuid);
          if (item) {
            buffer[uuid] = item.title;
            return item.title;
          }
        }
      }
      _makePeople(_libraries,_people,_teams,_query){
        if (!this._cachedPeople) {
          if (_libraries && _people && _teams) {
            var people = {};
            _people.forEach(p=>{
              if (p.computingId) {
                people[p.computingId] = p;
              }
            });
            // assign teams to people
            _teams.forEach(t=>{
              if (t.groupMembers)
                t.groupMembers.forEach(p=>{
                  if (people[p]) {
                    if (!people[p]['teams']) people[p]['teams'] = [t.uuid];
                    else people[p]['teams'].push(t.uuid);
                  }
                });
            });
            this._cachedPeople = Object.values(people);
            return this._cachedPeople;
          }
          return null;
        } else {
          return this._cachedPeople;
        }
      }
      _filter(_query,_list) {
        if (_query) {

        } else {
          return _query;
        }
      }
    }

    window.customElements.define(UvalibStaffDir.is, UvalibStaffDir);
  </script>
</dom-module>
