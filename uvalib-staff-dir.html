<link rel="import" href="uvalib-directory.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../uvalib-theme/uvalib-icons.html">
<link rel="import" href="../uva-helper-libs/polyfills/string.includes.html">
<link rel="import" href="../uva-helper-libs/polyfills/array.find.html">

<dom-module id="uvalib-staff-dir">
  <template>

<!--
      <template is="dom-if" if="[[!smallScreen]]" restamp>
          <vaadin-grid height-by-rows="[[largeScreen]]" theme="no-border row-stripes wrap-cell-content" aria-label="Staff directory listing" items="[[people]]">
            <vaadin-grid-column width="20%">
              <template class="header"><div class="team-text">Contact</div></template>
              <template>
                <div class="email"><a href="mailto:[[_getEmail(item)]]">[[_getEmail(item)]]</a></div>
                <div class="phone" hidden$="[[!item.phone]]"><a href="tel:[[item.phone]]">[[item.phone]]</a></div>
              </template>
            </vaadin-grid-column>


          </vaadin-grid>
      </template>

-->
  </template>

  <script>
    let uvalibStaffDirTemplate;

    /**
     * `uvalib-staff-dir`
     * UVA Library page layout component
     *
     * @customElement
     * @polymer
     * @demo demo/staff-dir.html
     * @demo demo/team-staff.html
     */
    class UvalibStaffDir extends UvalibDirectory {
      static get is() { return 'uvalib-staff-dir'; }
      static get properties() {
        return Object.assign(super.properties,
            {
              team: {
                type: String,
                value: null
              },
              _controls: {
                type: Boolean,
                computed: '_showControls(team)'
              },
              columns: {
                type: Array,
                computed: "_makeColumns(team)"
              }
            });
      }
      static get template() {
        if (!uvalibStaffDirTemplate) {
            // Retrieve this element's dom-module template
            uvalibStaffDirTemplate = Polymer.DomModule.import(this.is, 'template');
            // Clone the contents of the superclass template
            let superTemplateContents = UvalibDirectory.template.content.cloneNode(true);
            // Insert the superclass contents
            uvalibStaffDirTemplate.content.insertBefore(superTemplateContents,null);
        }
        return uvalibStaffDirTemplate;
      }

      _makeColumns(team){
        var cols = [];
        cols.push(
          {
            title:"Name",
            sortable:{dir:'asc',path:'lastName'},
            width:"20%",
            mkCell:function(item,that){
              return `<a href="/staff/${item.computingId}">${that._getName(item)}</p>`;
            }
          });
        cols.push(
          {
            title:"Title",
            width:"20%",
            mkCell:function(item){
              return item.jobTitle? item.jobTitle:"";
            }
          });
        if (!team) cols.push(
          {
            title:"Team",
            width:"20%",
            mkCell:function(item,that){
              return item.teams? item.teams.reduce((a,team)=>`<a href="/teams/${team}">${that._getTeamName(team)}</a><br />`,""):"";
            }
          });
        cols.push(
          {
            title:"Contact",
            width:"20%",
            mkCell:function(item,that){
              var tmp=`<div class="email"><a href="mailto:${that._getEmail(item)}">${that._getEmail(item)}</a></div>`;
              tmp+= item.phone? `<div class="phone"><a href="tel:${item.phone}">${item.phone}</a></div>`:"";
              return tmp;
            }
          });
        cols.push(
          {
            title:"Library",
            width:"20%",
            mkCell:function(item,that){
              return item.library?
                `<a href="/hours#${that._getLibrarySlug(item.library)}">${that._getLibraryName(item.library)}</a>`:
                "";
            }
          });
        return cols;
      }

      _peopleChanged(){
        this._filterRows(this._makePeople(this._libraries,this._people,this._teams));
      }

      _sortData(pep){
        if(pep) {
          var tmp = pep.sort(function(a,b){
            var alast = (a.lastName)? a.lastName:a.fullName;
            var blast = (b.lastName)? b.lastName:b.fullName;
            return (alast.toLowerCase() < blast.toLowerCase());
          });
          this.set('_data', tmp );
        }
      }

      _filter(query){
        if (query) {
          query = query.toLowerCase().trim().replace(/ +(?= )/g,'');
          return function(s) {
            var name = (s.lastName)? s.lastName:s.fullName;
            var searchString = s.displayName + " " + name;
            return (searchString.toLowerCase().indexOf(query) != -1);
          }.bind(this);
        } else if (this.team) {
          return function(p){
            return p.teams && p.teams.indexOf(this.team) > -1;
          }.bind(this);
        } else {
          return null;
        }
      }

      _makePeople(_libraries,_people,_teams){
        if (_libraries && _people && _teams) {
          if (!this._cachedPeople) {
            if (_libraries && _people && _teams) {
              var people = {};
              _people.forEach(p=>{
                if (p.computingId) {
                  people[p.computingId] = p;
                }
              });
              // assign teams to people
              _teams.forEach(t=>{
                if (t.groupMembers)
                  t.groupMembers.forEach(p=>{
                    if (people[p]) {
                      if (!people[p]['teams']) people[p]['teams'] = [t.uuid];
                      else people[p]['teams'].push(t.uuid);
                    }
                  });
              });
              this._cachedPeople = Object.values(people);
              return this._cachedPeople;
            }
            return null;
          } else {
            return this._cachedPeople;
          }
        }
      }

      _getName(person){
          if (person) return (person.displayName)?
            person.displayName:
            person.fullName;
      }

      _getEmail(person){
        return (person.email)?
          person.email:
          person.computingId+"@virginia.edu"
      }

      /* Don't show search if team is specified */
      _showControls(team){
        return !(team);
      }
    }

    window.customElements.define(UvalibStaffDir.is, UvalibStaffDir);
  </script>
</dom-module>
