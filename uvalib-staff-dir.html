<link rel="import" href="uvalib-directory.html">
<link rel="import" href="../iron-image/iron-image.html">

<dom-module id="uvalib-staff-dir">
  <template>
    <custom-style>
      <style include="uvalib-theme">
        iron-image {
          width:90px !important;
          height:90px !important;
        }
      </style>
    </custom-style>
  </template>

  <script>
    let uvalibStaffDirTemplate;

    /**
     * `uvalib-staff-dir`
     * UVA Library page layout component
     *
     * @customElement
     * @polymer
     * @demo demo/staff-dir.html
     * @demo demo/team-staff.html
     */
    class UvalibStaffDir extends UvalibDirectory {
      static get is() { return 'uvalib-staff-dir'; }
      static get properties() {
        return Object.assign(super.properties,
            {
              team: {
                type: String,
                value: null
              },
              _controls: {
                type: Boolean,
                computed: '_showControls(team)'
              },
              columns: {
                type: Array,
                computed: "_makeColumns(team)"
              },
              searchPlaceholder: {
                type: String,
                value: "Search for Library Staff"
              },
              showColumns: {
                type:String,
                value: "name,title,team,contact,library"
              }
            });
      }
      static get template() {
        if (!uvalibStaffDirTemplate) {
            // Retrieve this element's dom-module template
            uvalibStaffDirTemplate = Polymer.DomModule.import(this.is, 'template');
            // Clone the contents of the superclass template
            let superTemplateContents = UvalibDirectory.template.content.cloneNode(true);
            // Insert the superclass contents
            uvalibStaffDirTemplate.content.insertBefore(superTemplateContents,null);
        }
        return uvalibStaffDirTemplate;
      }

      _makeColumns(team){
        var cols = [];
        if (this.showColumns.indexOf("photo") > -1)
          cols.push(
            {
              width: "120px",
              flexGrow: 0,
              mkCell: function(item,that){
                return (item.field_image)?
                  `<iron-image alt="Image of ${item.displayName}" sizing="cover" position="top" fade class="round" src="${item.field_image.url.replace('https://drupal.lib.virginia.edu/sites/default','https://www.library.virginia.edu')}"></iron-image>`:"";
              }
            });
        if (this.showColumns.indexOf("name") > -1)
          cols.push(
            {
              title:"Name",
              sortable:{dir:'asc',path:'lastName'},
              mkCell:function(item,that){
                return `<a href="/staff/${item.computingId}">${that._getName(item)}</p>`;
              }
            });
        if (this.showColumns.indexOf("title") > -1)
          cols.push(
            {
              title:"Title",
              mkCell:function(item){
                return item.jobTitle? item.jobTitle:"";
              }
            });
        if (this.showColumns.indexOf("team") > -1 && !team)
          cols.push(
            {
              title:"Team",
              mkCell:function(item,that){
                return item.teams? item.teams.reduce((a,team)=>`<a href="/teams/${team}">${that._getTeamName(team)}</a><br />`,""):"";
              }
            });
        if (this.showColumns.indexOf("contact") > -1)
          cols.push(
            {
              title:"Contact",
              mkCell:function(item,that){
                var tmp=`<div class="email"><a href="mailto:${that._getEmail(item)}">${that._getEmail(item)}</a></div>`;
                tmp+= item.phone? `<div class="phone"><a href="tel:${item.phone}">${item.phone}</a></div>`:"";
                return tmp;
              }
            });
        if (this.showColumns.indexOf("library") > -1)
          cols.push(
            {
              title:"Library",
              mkCell:function(item,that){
                return item.library?
                  `<a href="/hours#${that._getLibrarySlug(item.library)}">${that._getLibraryName(item.library)}</a>`:
                  "";
              }
            });
        return cols;
      }

      _peopleChanged(){
        this._filterRows(this._makePeople(this._libraries,this._people,this._teams));
      }

      _sortData(pep){
        if(pep) {
          var tmp = pep.sort(function(a,b){
            var alast = (a.lastName)? a.lastName:a.fullName;
            var blast = (b.lastName)? b.lastName:b.fullName;
            return (alast.toLowerCase() < blast.toLowerCase());
          });
          this.set('_data', tmp );
        }
      }

      _filter(query){
        if (query) {
          query = query.toLowerCase().trim().replace(/ +(?= )/g,'');
          return function(s) {
            var name = (s.lastName)? s.lastName:s.fullName;
            var searchString = s.displayName + " " + name;
            return (searchString.toLowerCase().indexOf(query) != -1);
          }.bind(this);
        } else if (this.team) {
          return function(p){
            return p.teams && p.teams.indexOf(this.team) > -1;
          }.bind(this);
        } else {
          return null;
        }
      }

      _makePeople(_libraries,_people,_teams){
        if (_libraries && _people && _teams) {
          if (!this._cachedPeople) {
            if (_libraries && _people && _teams) {
              var people = {};
              _people.forEach(p=>{
                if (p.computingId) {
                  people[p.computingId] = p;
                }
              });
              // assign teams to people
              _teams.forEach(t=>{
                if (t.groupMembers)
                  t.groupMembers.forEach(p=>{
                    if (people[p]) {
                      if (!people[p]['teams']) people[p]['teams'] = [t.uuid];
                      else people[p]['teams'].push(t.uuid);
                    }
                  });
              });
              this._cachedPeople = Object.values(people);
              return this._cachedPeople;
            }
            return null;
          } else {
            return this._cachedPeople;
          }
        }
      }

      _getName(person){
          if (person) return (person.displayName)?
            person.displayName:
            person.fullName;
      }

      _getEmail(person){
        return (person.email)?
          person.email:
          person.computingId+"@virginia.edu"
      }

      /* Don't show search if team is specified */
      _showControls(team){
        return !(team);
      }
    }

    window.customElements.define(UvalibStaffDir.is, UvalibStaffDir);
  </script>
</dom-module>
