<link rel="import" href="../uvalib-theme/uvalib-ui-element.html">
<link rel="import" href="../uva-models/uva-library.html">
<link rel="import" href="../uvalib-theme/uvalib-theme.html">
<link rel="import" href="../paper-button/paper-button.html" >
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">

<dom-module id="uvalib-directory">
  <link rel="lazy-import" group="uvalib-directory-table" href="../vaadin-grid/vaadin-grid.html">
  <link rel="lazy-import" group="uvalib-directory-table" href="../vaadin-grid/vaadin-grid-sorter.html">
  <link rel="lazy-import" group="uvalib-directory-list" href="../iron-list/iron-list.html">
  <link rel="lazy-import" group="uvalib-directory-staffview" href="../uvalib-account/uvalib-account-user.html">
  <link rel="lazy-import" group="uvalib-directory-staffview" href="../app-storage/app-localstorage/app-localstorage-document.html" />

  <template>
    <custom-style>
      <style include="uvalib-theme">
        :host {
          display: block;
        }
        [hidden] {
          display: none;
        }
        #controls {
          padding-bottom: 20px;
        }
        vaadin-grid {
          --vaadin-grid-body-cell: { border: 1px solid green; };
          --vaadin-grid-cell-content: { border: 1px solid blue; };
        }
      </style>
    </custom-style>

    <template is="dom-if" if="[[staffView]]" restamp>
      <uvalib-account-user id="accountuser" signed-in="{{_signedIn}}" lib-staff="{{_staffmember}}"></uvalib-account-user>
      <app-localstorage-document key="uvalib-staff-view" data="{{_staffView}}"></app-localstorage-document>
    </template>
    <uva-library last-response="{{_libraries}}"></uva-library>
    <uva-library path="people" last-response="{{_people}}"></uva-library>
    <uva-library path="teams" last-response="{{_teams}}"></uva-library>
    <uva-library path="services" last-response="{{_services}}"></uva-library>

    <div id="controls">
        <template is="dom-if" if="[[staffView]]" restamp>
          <div id="login-buttons">
            <paper-button on-tap="_signIn" hidden$="[[_signedIn]]" raised>Staff Login</paper-button>
            <paper-button on-tap="_signOut" hidden$="[[!_signedIn]]" raised>Sign Out</paper-button>
          </div>
        </template>
        <template is="dom-if" if="[[!smallScreen]]" restamp>
          <paper-input label="[[searchPlaceholder]]" value="{{_query}}">
            <div slot="prefix">
              <span class="uvalib-icon-search uva-padding-right"></span>
            </div>
          </paper-input>
          <template is="dom-if" if="[[staffView]]" restamp>
            <paper-toggle-button id="staffSelect" checked="{{_staffView}}" hidden$="[[!_staffmember]]" class="orange">
              <template is="dom-if" if="[[_staffView]]"><span class"staff-text">Staff View</span></template>
              <template is="dom-if" if="[[!_staffView]]">Public View</template>
            </paper-toggle-button>
          </template>
        </template>
        <template is="dom-if" if="[[smallScreen]]" restamp>
          <template is="dom-if" if="[[staffView]]" restamp>
            <paper-toggle-button id="staffSelect" checked="{{_staffView}}" hidden$="[[!_staffmember]]" class="orange">
              <template is="dom-if" if="[[_staffView]]"><span class"staff-text">Staff View</span></template>
              <template is="dom-if" if="[[!_staffView]]">Public View</template>
            </paper-toggle-button>
          </template>
          <div class="uva-margin-top">
            <paper-input label="Search the directory" value="{{_query}}">
              <div slot="prefix">
                <span class="uvalib-icon-search uva-padding-right"></span>
              </div>
            </paper-input>
          </div>
        </template>
    </div>

  </template>

  <script>
    let uvalibDirectoryTemplate;

    /**
     * `uvalib-directory`
     * UVA Library directory conponent
     *
     * @customElement
     * @polymer
     * @demo demo/directory.html
     */
    class UvalibDirectory extends UvalibUiElement {
      static get is() { return 'uvalib-directory'; }
      static get properties() {
        return Object.assign(super.properties,
            {
              _init: Boolean,
              _query: {
                type:String,
                observer: "_filterRows"
              },
              _libraries: {
                type: Array,
                notify: true,
                observer: "_librariesChanged"
              },
              _people: {
                type: Array,
                notify: true,
                observer: "_peopleChanged"
              },
              _teams: {
                type: Array,
                notify: true,
                observer: "_teamsChanged"
              },
              _services: {
                type:Array,
                notify: true,
                observer: "_servicesChanged"
              },

              staffView: {
                type: Boolean,
                value: false,
                observer: "_staffViewChanged"
              },
              _signedIn: Boolean,
              _staffmember: {
                type: Boolean,
                value: false,
                observer: "_staffmemberChange"
              },
              _staffView: {
                type: Boolean,
                value: false,
                notify: true,
                observer: "_filterRows"
              },
              searchPlaceholder: {
                type: String,
                value: "Search the directory"
              }
            });
      }
      static get template() {
        if (!uvalibDirectoryTemplate) {
            // Retrieve this element's dom-module template
            uvalibDirectoryTemplate = Polymer.DomModule.import(this.is, 'template');

            // Clone the contents of the superclass template
            let superTemplateContents = document.importNode(UvalibUiElement.template.content, true);

            // Insert the superclass contents
            uvalibDirectoryTemplate.content.insertBefore(superTemplateContents, null);
        }
        return uvalibDirectoryTemplate;
      }

      _librariesChanged(){}
      _peopleChanged(){}
      _teamsChanged(){}
      _servicesChanged(){}

      _staffViewChanged(){
        if (this._init && this.staffView)
          this.importLazyGroup("uvalib-directory-staffview");
      }
      _staffmemberChange() {
        if (this._staffmember) this._staffView = true;
      }

      _filterRows(){}
      _screenChanged(){
        // load vaadin grid for larger than small screens
        if (!this.smallScreen)
          this.importLazyGroup('uvalib-directory-table');
        else
          this.importLazyGroup('uvalib-directory-list');
      }
      ready(){
        super.ready();
        // the lazy import library only looks as far as the local dom for lazy-imports
        // copy this elements imports into the element that is extending this
        var query = 'link[rel=\'lazy-import\'][href]:not([href=\'\'])';
        var links = Polymer.DomModule.import('uvalib-directory').querySelectorAll(query);
        var container = Polymer.DomModule.import(this.localName)
        for (var i = 0; i < links.length; i++) {
          container.appendChild(links[i])
        }
        this._init = true;
        this._staffViewChanged();
      }
    }

    window.customElements.define(UvalibDirectory.is, UvalibDirectory);
  </script>
</dom-module>
