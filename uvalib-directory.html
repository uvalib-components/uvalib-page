<link rel="import" href="../uvalib-theme/uvalib-ui-element.html">
<link rel="import" href="../uva-models/uva-library.html">
<link rel="import" href="../uvalib-theme/uvalib-theme.html">
<link rel="import" href="../paper-button/paper-button.html" >
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">

<dom-module id="uvalib-directory">
  <link rel="lazy-import" group="uvalib-directory-table" href="../vaadin-grid/vaadin-grid.html">
  <link rel="lazy-import" group="uvalib-directory-table" href="../vaadin-grid/vaadin-grid-sorter.html">
  <link rel="lazy-import" group="uvalib-directory-list" href="../iron-list/iron-list.html">
  <link rel="lazy-import" group="uvalib-directory-staffview" href="../uvalib-account/uvalib-account-user.html">
  <link rel="lazy-import" group="uvalib-directory-staffview" href="../app-storage/app-localstorage/app-localstorage-document.html" />

  <template>
    <custom-style>
      <style include="uvalib-theme">
        :host {
          display: block;
        }
        [hidden] {
          display: none;
        }
        #controls {
          padding-bottom: 20px;
        }
        vaadin-grid {
          --vaadin-grid-body-cell: { border: 1px solid green; };
          --vaadin-grid-cell-content: { border: 1px solid blue; };
        }
        .title-text {
          font-size: var(--uvalib-main-font-size-unit);
          font-weight: 700;
        }
        paper-toggle-button.orange {
          --paper-toggle-button-checked-bar-color:  var(--uvalib-main-rotunda-orange);
          --paper-toggle-button-checked-button-color:  var(--uvalib-main-rotunda-orange);
          --paper-toggle-button-checked-ink-color: var(--uvalib-main-rotunda-orange);
        }
        /* Adds Border and Text for Staff-only items */
        [staff] {
          border-left: calc(var(--uvalib-spacing-unit)/2) solid var(--uvalib-main-rotunda-orange);
          padding-left: var(--uvalib-spacing-unit);
          margin-left: calc(var(--uvalib-spacing-unit)*-1);
        }
        span[staff-text] {
          @apply --h4;
          font-size: var(--uvalib-main-font-size-unit);
          color: var(--uvalib-main-jefferson-blue);
          margin-top: calc(var(--uvalib-spacing-unit)/1.6);
          display: inline-block;
          text-transform: uppercase;
          font-style: italic;
        }
        .mobileDirectory .title-text:first-of-type {
          display:none;
        }
        .mobileDirectory {
          margin-left: calc(var(--uvalib-spacing-unit)*-1);
          margin-right: calc(var(--uvalib-spacing-unit)*-1);
          padding-bottom: var(--uvalib-spacing-unit);
          padding-left: calc(var(--uvalib-spacing-unit)*2);
          padding-right: calc(var(--uvalib-spacing-unit)*2);
        }
        .mobileDirectory .title-text {
          margin-top: var(--uvalib-spacing-unit);
        }
        .mobileDirectory ul {
          margin-top: 0;
          margin-bottom: 0;
        }
        .mobileDirectory:nth-child(odd) {
            background-color: var(--color-light-gray);
        }
        #login-buttons {
          float: right;
        }
        /*MOBILE*/
        iron-list {
          width: 100%;
        }
      </style>
    </custom-style>

    <template is="dom-if" if="[[staffView]]" restamp>
      <uvalib-account-user id="accountuser" signed-in="{{_signedIn}}" lib-staff="{{_staffmember}}"></uvalib-account-user>
      <app-localstorage-document key="uvalib-staff-view" data="{{_staffView}}"></app-localstorage-document>
    </template>
    <uva-library last-response="{{_libraries}}"></uva-library>
    <uva-library path="people" last-response="{{_people}}"></uva-library>
    <uva-library path="teams" last-response="{{_teams}}"></uva-library>
    <uva-library path="areas" last-response="{{_areas}}"></uva-library>
    <uva-library path="services" last-response="{{_services}}"></uva-library>

    <!-- Control section -->
    <template is="dom-if" if="[[_controls]]">
      <div id="controls">
          <template is="dom-if" if="[[staffView]]" restamp>
            <div id="login-buttons">
              <paper-button on-tap="_signIn" hidden$="[[_signedIn]]" raised>Staff Login</paper-button>
              <paper-button on-tap="_signOut" hidden$="[[!_signedIn]]" raised>Sign Out</paper-button>
            </div>
          </template>
          <template is="dom-if" if="[[!smallScreen]]" restamp>
            <paper-input label="[[searchPlaceholder]]" value="{{_query}}">
              <div slot="prefix">
                <span class="uvalib-icon-search uva-padding-right"></span>
              </div>
            </paper-input>
            <template is="dom-if" if="[[staffView]]" restamp>
              <paper-toggle-button id="staffSelect" checked="{{_staffView}}" hidden$="[[!_staffmember]]" class="orange">
                <template is="dom-if" if="[[_staffView]]"><span class"staff-text">Staff View</span></template>
                <template is="dom-if" if="[[!_staffView]]">Public View</template>
              </paper-toggle-button>
            </template>
          </template>
          <template is="dom-if" if="[[smallScreen]]" restamp>
            <template is="dom-if" if="[[staffView]]" restamp>
              <paper-toggle-button id="staffSelect" checked="{{_staffView}}" hidden$="[[!_staffmember]]" class="orange">
                <template is="dom-if" if="[[_staffView]]"><span class"staff-text">Staff View</span></template>
                <template is="dom-if" if="[[!_staffView]]">Public View</template>
              </paper-toggle-button>
            </template>
            <div class="uva-margin-top">
              <paper-input label="Search the directory" value="{{_query}}">
                <div slot="prefix">
                  <span class="uvalib-icon-search uva-padding-right"></span>
                </div>
              </paper-input>
            </div>
          </template>
      </div>
    </template>

    <!-- Vaadin grid table for larger screens -->
    <template is="dom-if" if="[[!smallScreen]]" restamp>

      <vaadin-grid height-by-rows="[[largeScreen]]" theme="no-border row-stripes wrap-cell-content" aria-label="Service directory listing" items="[[_data]]">
        <template is="dom-repeat" items="[[columns]]" as="col">
          <vaadin-grid-column width="[[col.width]]" flex-grow="[[col.flexGrow]]">
            <template is="dom-if" if="dom-if" if="[[col.title]]">
              <template class="header">
                <template is="dom-if" if="[[col.sortable]]">
                  <vaadin-grid-sorter direction="[[col.sortable.dir]]" path="[[col.sortable.path]]">
                    <div class="title-text">[[col.title]]</div>
                  </vaadin-grid-sorter>
                </template>
                <template is="dom-if" if="[[!col.sortable]]">
                  <div class="title-text">[[col.title]]</div>
                </template>
              </template>
            </template>
            <template>
              <div staff$="[[_and(col.highlight,item.audience)]]" inner-h-t-m-l="[[_mkCell(col,item)]]"></div>
            </template>
          </vaadin-grid-column>
        </template>

      </vaadin-grid>

    </template>
    <template is="dom-if" if="[[smallScreen]]" restamp>
      <iron-list items="[[_data]]" scroll-target="document" scroll-offset="200">
        <template>
          <div class="mobileDirectory" even$="[[_isEven(index)]]" staff$="[[item.audience]]">
            <template is="dom-repeat" items="[[columns]]" as="col">
              <template is="dom-if" if="[[_isNull(col,item)]]">
                <div class="title-text">[[col.title]]</div>
                <div class="service" inner-h-t-m-l="[[_mkCell(col,item)]]"></div>
              </template>
            </template>
          </div>
        </template>
      </iron-list>
    </template>

  </template>

  <script>
    let uvalibDirectoryTemplate;

    /**
     * `uvalib-directory`
     * UVA Library directory conponent
     *
     * @customElement
     * @polymer
     * @demo demo/directory.html
     */
    class UvalibDirectory extends UvalibUiElement {
      static get is() { return 'uvalib-directory'; }
      static get properties() {
        return Object.assign(super.properties,
            {
              _controls: {
                type: Boolean,
                value: true
              },
              _init: Boolean,
              _query: {
                type:String,
                observer: "_refresh"
              },
              _libraries: {
                type: Array,
                notify: true,
                observer: "_librariesChanged"
              },
              _people: {
                type: Array,
                notify: true,
                observer: "_peopleChanged"
              },
              _teams: {
                type: Array,
                notify: true,
                observer: "_teamsChanged"
              },
              _areas: {
                type: Array,
                notify: true,
                observer: "_areasChanged"
              },
              _services: {
                type:Array,
                notify: true,
                observer: "_servicesChanged"
              },

              staffView: {
                type: Boolean,
                value: false,
                observer: "_staffViewChanged"
              },
              _signedIn: Boolean,
              _staffmember: {
                type: Boolean,
                value: false,
                observer: "_staffmemberChange"
              },
              _staffView: {
                type: Boolean,
                value: false,
                notify: true,
                observer: "_refresh"
              },
              searchPlaceholder: {
                type: String,
                value: "Search the directory"
              },
              _data: {
                type: Array,
                value: function(){ return []; },
                notify: true
              }
            });
      }
      static get template() {
        if (!uvalibDirectoryTemplate) {
            // Retrieve this element's dom-module template
            uvalibDirectoryTemplate = Polymer.DomModule.import(this.is, 'template');
            // Clone the contents of the superclass template
            let superTemplateContents = UvalibUiElement.template.content.cloneNode(true);
            // Insert the superclass contents
            uvalibDirectoryTemplate.content.insertBefore(superTemplateContents, null);
        }
        return uvalibDirectoryTemplate;
      }

      _and(a,b){
        return a && b;
      }

      _mkCell(col,item) {
        if (item && col.mkCell)
          return col.mkCell(item,this);
      }
      _isNull(col,item){
        if (!item) return false;
        else if (col.isNull)
          return col.isNull(item,this);
        else return true;
      }

      _librariesChanged(){}
      _peopleChanged(){}
      _teamsChanged(){}
      _areasChanged(){}
      _servicesChanged(){}

      _staffViewChanged(){
        if (this._init && this.staffView)
          this.importLazyGroup("uvalib-directory-staffview");
      }
      _staffmemberChange() {
        if (this._staffmember) this._staffView = true;
      }

      _screenChanged(){
        // load vaadin grid for larger than small screens
        if (!this.smallScreen)
          this.importLazyGroup('uvalib-directory-table');
        else
          this.importLazyGroup('uvalib-directory-list');
      }
      ready(){
        super.ready();
        // the lazy import library only looks as far as the local dom for lazy-imports
        // copy this elements imports into the element that is extending this
        var query = 'link[rel=\'lazy-import\'][href]:not([href=\'\'])';
        var links = Polymer.DomModule.import('uvalib-directory').querySelectorAll(query);
        var container = Polymer.DomModule.import(this.localName)
        for (var i = 0; i < links.length; i++) {
          container.appendChild(links[i])
        }
        this._init = true;
        this._staffViewChanged();
      }
      _signIn() {
        this.shadowRoot.getElementById('accountuser').signInWithNetbadge();
      }
      _signOut() {
        this.shadowRoot.getElementById('accountuser').signOut();
        this._staffView = false;
      }
      _getLibrarySlug(uuid){
        if (! this._libSlugs ) this._libSlugs = {}
        return this._getListValue(this._libraries,this._libSlugs,uuid,'slug');
      }
      _getLibraryName(uuid){
        if (! this._libNames ) this._libNames = {}
        return this._getListValue(this._libraries,this._libNames,uuid,'title');
      }
      _getTeamName(uuid){
        if (! this._teamNames ) this._teamNames = {}
        return this._getListValue(this._teams,this._teamNames,uuid,'title');
      }
      _getAreaName(uuid){
        if (! this._areaNames ) this._areaNames = {}
        return this._getListValue(this._areas,this._areaNames,uuid,'title');
      }
      _getListValue(list,buffer,uuid,prop){
        if (list && uuid) {
          if (buffer[uuid]) return buffer[uuid];
          var item = list.find( item => item.uuid === uuid);
          if (item) {
            buffer[uuid] = item[prop];
            return item[prop];
          }
        }
      }
      _getPersonName(uuid){
        if (this._people && uuid) {
          var person = this._people.find( person => person.uuid === uuid);
          if (person) return person.displayName;
        }
      }
      _getPersonID(uuid){
        if (this._people && uuid) {
          var person = this._people.find( person => person.uuid === uuid);
          if (person) return person.computingId;
        }
      }
      _isEven(n) {
        n = Number(n);
        return n === 0 || !!(n && !(n%2));
      }
      _getLibs(libs){
        if (!libs) {
          return [];
        } else {
          libs = Array.isArray(libs)?libs:[libs];
          return libs.map(function(lib){
            lib.title = this._getLibraryName(lib.uuid);
            return lib;
          }.bind(this));
        }
      }

      _isDataReady() {
        return this._libraries && this._libraries.length > 0 && this._services && this._services.length > 0 && this._teams && this._people;
      }

      _refresh(){
        if (this._rows) this._filterRows(this._rows);
      }
      _filterRows(rows) {
        this._rows = rows;
        //clone the pristine services listing so that we can come back from filters w/o reloading
        if (this._isDataReady() && rows){
          var data = JSON.parse(JSON.stringify(rows));
          this._sortData(this._filterData(data));
        } else {
          setTimeout(function(){this._filterRows(rows)}.bind(this),500);
        }
      }

      _filterData(data){
        var filter = this._filter(this._query);
        if (filter) {
          data = data.filter( filter );
        }
        if (!this._staffView) {
          if (data.filter)
            return data.filter( (s)=>(!s.audience || s.audience != "staff") );
        } else {
          return data;
        }
        return data;
      }
    }

    window.customElements.define(UvalibDirectory.is, UvalibDirectory);
  </script>
</dom-module>
