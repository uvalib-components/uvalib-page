<link rel="import" href="uvalib-directory.html">
<link rel="import" href="../uvalib-theme/uvalib-icons.html">
<link rel="import" href="../uva-helper-libs/polyfills/string.includes.html">
<link rel="import" href="../uva-helper-libs/polyfills/array.find.html">


<dom-module id="uvalib-services">
  <template>
    <custom-style>
      <style include="uvalib-theme">
        .service-title {
          font-size: var(--uvalib-main-font-size-unit);
          font-weight: 700;
          padding-top: var(--uvalib-spacing-unit);
        }
        .service-description p {
          margin-top: 0;
        }
        .services-location {
          list-style: none;
          padding-left: 0;
        }
        .services-location li {
          line-height: calc(var(--uvalib-spacing-unit)*1.1);
          padding-bottom: var(--uvalib-spacing-unit);
        }
        .mobileDirectory .service-title {
          font-size: calc(var(--uvalib-main-font-size-unit)*1.2);
        }
        .mobileDirectory .services-location li {
          padding-bottom: calc(var(--uvalib-spacing-unit)/2);
        }
      </style>
    </custom-style>

  </template>

  <script>
    let uvalibServicesTemplate;

    /**
     * `uvalib-services`
     * UVA Library page layout component
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvalibServices extends UvalibDirectory {
      static get is() { return 'uvalib-services'; }
      static get properties() {
        return Object.assign(super.properties,
            {
              staffView: {
                type: Boolean,
                value: true
              },
              searchPlaceholder: {
                type: String,
                value: "Search for staff"
              },
              columns: {
                type: Array,
                value: [
                  {
                    title:"Service",
                    sortable:{dir:'asc',path:'title'},
                    width:"45%",
                    mkCell:function(item){
                      var hideTitle = (item.siteLink)?"hidden":"",
                          hideLink = (item.siteLink)?"":"hidden",
                          hideBody = (item.body)?"":"hidden",
                          hideAudience = (item.audience)?"":"hidden",
                          staffText = (item.audience)?"staff-text":"";
                      return `
                        <div class="title service-title" ${hideTitle}>${item.title}</div>
                        <div class="title service-title" ${hideLink}><a href="${item.siteLink}">${item.title}</a></div>
                        <div class="description service-description" ${hideBody}>${item.body}</div>
                        <span ${hideAudience} ${staffText}>staff info</span>
                      `;
                    }
                  },
                  {
                    title:"Location",
                    width:"30%",
                    isNull:function(item,that){
                      return !!(item.library);
                    },
                    mkCell:function(item,that){
                      if (that._getLibs) {
                        var libraries = that._getLibs(item.library);
                        if (libraries.length > 0) {
                          var libs = '<div class="services-location">';
                          libraries.forEach(lib=>libs+=`<a href="/hours#${that._getLibrarySlug(lib.uuid)}">${lib.title}</a><br />`);
                          libs+='</div>';
                          return libs;
                        } else {
                          return "";
                        }
                      }
                    }
                  },
                  {
                    title:"Contact",
                    width:"35%",
                    isNull:function(item,that){
                      return (item.emailAddress || item.phoneNumber || item.fromLink || (that._staffView && (item.owner || item.team)));
                    },
                    mkCell:function(item,that){
                      var cell = "";
                      if (item.emailAddress)
                        cell += `<div class="email"><a href="mailto:${item.emailAddress}">${item.emailAddress}</a></div>`;
                      if (item.phoneNumber)
                        cell +=`<div class="phone"><a href="tel:${item.phoneNumber}">${item.phoneNumber}</a></div>`;
                      if (item.formLink)
                        cell +=`<div class="form"><a href="${item.formLink}">Contact form</a></div>`;
                      if (that._staffView) {
                        cell +="<div>";
                          if (item.owner)
                            cell+=`<div class="owner-person">Owner: <a href="/staff/${that._getPersonID(item.owner,that._people)}">${that._getPersonName(item.owner,that._people)}</a></div>`;
                          if (item.team)
                            cell+=`<div class="owner-person">Team Owner: <a href="/teams/${item.team}">${that._getTeamName(item.team,that._teams)}</a></div>`;
                        cell +="</div>";
                      }
                      return cell;
                    }
                  }
                ]
              }
            });
      }
      static get template() {
        if (!uvalibServicesTemplate) {
            // Retrieve this element's dom-module template
            uvalibServicesTemplate = Polymer.DomModule.import(this.is, 'template');
            // Clone the contents of the superclass template
            let superTemplateContents = document.importNode(UvalibDirectory.template.content, true);
            // Insert the superclass contents
            uvalibServicesTemplate.content.insertBefore(superTemplateContents,null);
        }
        return uvalibServicesTemplate;
      }


      _servicesChanged(){this._filterRows();}
      _filterRows() {
        //clone the pristine services listing so that we can come back from filters w/o reloading
        if (this._libraries && this._libraries.length > 0 && this._services){
          var data = JSON.parse(JSON.stringify(this._services));
          this._sortData(this._filterData(data));
        } else {
          setTimeout(function(){this._filterRows()}.bind(this),500);
        }
      }
      _filterData(data){
        if (this._query) {
          data = data.filter( this._filter(this._query) );
        }
        if (!this._staffView) {
          return data.filter( (s)=>(!s.audience || s.audience != "staff") );
        } else {
          return data;
        }
      }
      _sortChange(){
        if(this._data) {
          this._sortData( JSON.parse(JSON.stringify(this._data)) );
        }
      }
      _sortData(data){
        var dir = "desc";
        if(data) {
          data.sort(function(a,b){
            if (dir === "desc") {
              return a.title.toLowerCase().localeCompare(b.title.toLowerCase());
            } else {
              return b.title.toLowerCase().localeCompare(a.title.toLowerCase());
            }
          });
          this.set('_data', data );
        }
      }
      _filter(query){
        if (!query) {
          return null;
        } else {
          query = query.toLowerCase().trim().replace(/ +(?= )/g,'');
          return function(s) {
            var title = s.title.toLowerCase();
            if (s.library)
              var loc = this._getLibs(s.library).reduce((a,b)=>a+" "+b.title,"").toLowerCase();
            else var loc = "";
            return (title.indexOf(query) != -1 || loc.indexOf(query) != -1);
          }.bind(this);
        }
      }
      _mobileContact(emailAddress,phoneNumber,formLink) {
        return emailAddress || phoneNumber || formLink;
      }
    }

    window.customElements.define(UvalibServices.is, UvalibServices);
  </script>
</dom-module>
