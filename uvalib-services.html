<link rel="import" href="../uvalib-theme/uvalib-ui-element.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../uvalib-theme/uvalib-icons.html">
<link rel="import" href="../uva-models/uva-library.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../uva-helper-libs/polyfills/string.includes.html">

<link rel="import" href="../paper-datatable-api/paper-datatable-api-column.html">
<link rel="import" href="../paper-datatable-api/paper-datatable-api.html">

<dom-module id="uvalib-services">
  <template>
    <style>
      :host {
        display: block;
      }

    </style>

    <uva-library id="libs" last-response="{{_libraries}}"></uva-library>
    <uva-library path="services" last-response="{{_services}}"></uva-library>

    <paper-datatable-api data="[[_data]]" on-sort="_handleSort">
      <paper-datatable-api-column header="Service" property="title" sortable>
        <template>
          <span>{{value}}</span>
        </template>
      </paper-datatable-api-column>
      <paper-datatable-api-column header="Location" property="id" sortable>
        <template>
          <span>{{value}}</span>
        </template>
      </paper-datatable-api-column>
      <paper-datatable-api-column header="Contact" property="uuid">
        <template>
          <span>{{value}}</span>
        </template>
      </paper-datatable-api-column>
    </paper-datatable-api>

  </template>

  <script>
    /**
     * `uvalib-services`
     * UVA Library page layout component
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvalibServices extends UvalibUiElement {
      static get is() { return 'uvalib-services'; }
      static get properties() {
        return Object.assign(super.properties,
            {
              _libraries: {
                type: Array,
                notify: true,
                observer: "_addLibs"
              },
              _services: {
                type:Array,
                notify: true,
                observer: "_mkServices"
              },
              _data: {
                type: Array,
                value: function(){ return []; },
                notify: true
              }
            });
      }
      //Concat the this elements template with the parents
      static get template() {
        var parentTemplate = UvalibUiElement.template.cloneNode(true);
        var childTemplate = Polymer.DomModule.import('uvalib-services', 'template');
        parentTemplate.content.insertBefore(childTemplate.content,null);
        return parentTemplate;
      }
      _addLibs() {
        if (this._data && this._data.length > 0) {}
      }
      _mkServices() {
        //clone the pristine services listing so that we can come back from filters w/o reloading
        this._data = JSON.parse(JSON.stringify(this._services));
      }
      _handleSort(event) {
        console.log(event.detail.sort.property + ',' + event.detail.sort.direction);
      }
      _getLibs(libs){
        if (!libs) {
          return "online";
        } else {
          if (!this._libs) {
            this._libs = this.$.libs.getHash('id',['title']);
          }
          if (Object.keys(this._libs).length > 0) {
            libs = Array.isArray(libs)?libs:[libs];
            return libs.map(a => this._libs[a.id].title).sort().join(', ');
          }
          return "";
        }
      }
      _copy(aObject) {
        var bObject, v, k;
        bObject = Array.isArray(aObject) ? [] : {};
        for (k in aObject) {
          v = aObject[k];
          bObject[k] = (typeof v === "object") ? this._copy(v) : v;
        }
        return bObject;
      }
      _alphaSort(a,b){
        return a.title.toLowerCase().localeCompare(b.title.toLowerCase());
      }
      _filt(){
        if(Array.isArray(this.services)) {

          var l = this.services.map( (s) => this._copy(s) );
          l.sort(this._alphaSort);
          if (this._query) {
            return l.filter(function(s){
                      return s.title.toLowerCase().includes(this._query.toLowerCase().trim().replace(/ +(?= )/g,''))
                             ||
                             this._getLibs(s.library).toLowerCase().includes(this._query.toLowerCase().trim().replace(/ +(?= )/g,''));
                    }.bind(this));
          } else {
            return l;
          }

        }
      }

    }

    window.customElements.define(UvalibServices.is, UvalibServices);
  </script>
</dom-module>
