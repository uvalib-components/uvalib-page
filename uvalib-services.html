<link rel="import" href="uvalib-directory.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../uvalib-theme/uvalib-icons.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../uva-helper-libs/polyfills/string.includes.html">
<link rel="import" href="../uva-helper-libs/polyfills/array.find.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../paper-button/paper-button.html" >
<link rel="import" href="../app-storage/app-localstorage/app-localstorage-document.html" />
<link rel="import" href="../uvalib-account/uvalib-account-user.html">
<link rel="import" href="../iron-list/iron-list.html">

<dom-module id="uvalib-services">
  <template>
    <custom-style>
      <style include="uvalib-theme">

        .title-text {
          font-size: var(--uvalib-main-font-size-unit);
          font-weight: 700;
        }
        .service-title {
          font-size: var(--uvalib-main-font-size-unit);
          font-weight: 700;
          padding-top: var(--uvalib-spacing-unit);
        }
        .service-description p {
          margin-top: 0;
        }
        .services-location {
          list-style: none;
          padding-left: 0;
        }
        .services-location li {
          line-height: calc(var(--uvalib-spacing-unit)*1.1);
          padding-bottom: var(--uvalib-spacing-unit);
        }

        paper-toggle-button.orange {
          --paper-toggle-button-checked-bar-color:  var(--uvalib-main-rotunda-orange);
          --paper-toggle-button-checked-button-color:  var(--uvalib-main-rotunda-orange);
          --paper-toggle-button-checked-ink-color: var(--uvalib-main-rotunda-orange);
        }

        /* Adds Border and Text for Staff-only items */
        [staff] {
          border-left: calc(var(--uvalib-spacing-unit)/2) solid var(--uvalib-main-rotunda-orange);
          padding-left: var(--uvalib-spacing-unit);
          margin-left: calc(var(--uvalib-spacing-unit)*-1);
        }
        span[staff-text] {
          @apply --h4;
          font-size: var(--uvalib-main-font-size-unit);
          color: var(--uvalib-main-jefferson-blue);
          margin-top: calc(var(--uvalib-spacing-unit)/1.6);
          display: inline-block;
          text-transform: uppercase;
          font-style: italic;
        }

        /*MOBILE*/
        iron-list {
/*          display: inline-block; */
          height: 100vh;
          width: 100%;
        }

        #mobileDirectory {
          margin-left: calc(var(--uvalib-spacing-unit)*-1);
          margin-right: calc(var(--uvalib-spacing-unit)*-1);
          padding-bottom: var(--uvalib-spacing-unit);
          padding-left: calc(var(--uvalib-spacing-unit)*2);
          padding-right: calc(var(--uvalib-spacing-unit)*2);
        }

        #mobileDirectory .service-title {
          font-size: calc(var(--uvalib-main-font-size-unit)*1.2);
        }

        #mobileDirectory .title-text {
          margin-top: var(--uvalib-spacing-unit);
        }
        #mobileDirectory ul {
          margin-top: 0;
          margin-bottom: 0;
        }

        #mobileDirectory .services-location li {
          padding-bottom: calc(var(--uvalib-spacing-unit)/2);
        }

        #mobileDirectory:nth-child(odd) {
            background-color: var(--color-light-gray);
        }

        #login-buttons {
          float: right;
        }
      </style>
    </custom-style>

    <uvalib-account-user id="accountuser" signed-in="{{_signedIn}}" lib-staff="{{_staffmember}}"></uvalib-account-user>
    <app-localstorage-document key="uvalib-staff-view" data="{{_staffView}}"></app-localstorage-document>


      <template is="dom-if" if="[[!smallScreen]]" restamp>
        <div id="controls">

          <div id="login-buttons">
            <paper-button on-tap="_signIn" hidden$="[[_signedIn]]" raised>Staff Login</paper-button>
            <paper-button on-tap="_signOut" hidden$="[[!_signedIn]]" raised>Sign Out</paper-button>
          </div>

          <paper-input label="Search the directory" value="{{_query}}">
            <div slot="prefix">
              <span class="uvalib-icon-search uva-padding-right"></span>
            </div>
          </paper-input>
          <paper-toggle-button id="staffSelect" checked="{{_staffView}}" hidden$="[[!_staffmember]]" class="orange">
            <template is="dom-if" if="[[_staffView]]"><span class"staff-text">Staff View</span></template>
            <template is="dom-if" if="[[!_staffView]]">Public View</template>
          </paper-toggle-button>
        </div>
        <vaadin-grid height-by-rows="[[largeScreen]]" theme="no-border row-stripes wrap-cell-content" aria-label="Service directory listing" items="[[_data]]">
          <vaadin-grid-column width="45%">
            <template class="header"><vaadin-grid-sorter direction="asc" path="title"><div class="title-text">Service</div></vaadin-grid-sorter></template>
            <template>
              <div staff$="[[item.audience]]">
                <div class="title service-title" hidden$="[[item.siteLink]]">[[item.title]]</div>
                <div class="title service-title" hidden$="[[!item.siteLink]]"><a href="[[item.siteLink]]">[[item.title]]</a></div>
                <div class="description service-description" hidden$="[[!item.body]]" inner-h-t-m-l="[[item.body]]"></div>
                <span hidden$="[[!item.audience]]" staff-text$="[[item.audience]]">staff info</span>
              </div>
            </template>
          </vaadin-grid-column>
          <vaadin-grid-column width="30%">
            <template class="header"><div class="title-text">Location</div></template>
            <template><div class="location" inner-h-t-m-l="[[_getLibs(item.library)]]"></div></template>
          </vaadin-grid-column>
          <vaadin-grid-column width="25%">
            <template class="header"><div class="title-text">Contact</div></template>
            <template>
              <div class="email" hidden$="[[!item.emailAddress]]"><a href="mailto:[[item.emailAddress]]">[[item.emailAddress]]</a></div>
              <div class="phone" hidden$="[[!item.phoneNumber]]"><a href="tel:[[item.phoneNumber]]">[[item.phoneNumber]]</a></div>
              <div class="form" hidden$="[[!item.formLink]]"><a href="[[item.formLink]]">Contact form</a></div>
              <div hidden$="[[!_staffView]]">
                  <div class="owner-person" hidden$="[[!item.owner]]">Owner: [[_getPersonName(item.owner,_people)]]</div>
                  <div class="owner-person" hidden$="[[!item.team]]">Team Owner: [[_getTeamName(item.team,_teams)]]</div>
              </div>
            </template>
          </vaadin-grid-column>
        </vaadin-grid>

      </template>
      <template is="dom-if" if="[[smallScreen]]" restamp>
        <div id="controls">
          <div id="login-buttons">
            <paper-button on-tap="_signIn" hidden$="[[_signedIn]]" raised>Staff Login</paper-button>
            <paper-button on-tap="_signOut" hidden$="[[!_signedIn]]" raised>Sign Out</paper-button>
          </div>
          <paper-toggle-button id="staffSelect" checked="{{_staffView}}" hidden$="[[!_staffmember]]" class="orange">
            <template is="dom-if" if="[[_staffView]]"><span class"staff-text">Staff View</span></template>
            <template is="dom-if" if="[[!_staffView]]">Public View</template>
          </paper-toggle-button>
          <div class="uva-margin-top">
            <paper-input label="Search the directory" value="{{_query}}">
              <div slot="prefix">
                <span class="uvalib-icon-search uva-padding-right"></span>
              </div>
            </paper-input>
          </div>
        </div>
        <iron-list items="[[_data]]" scroll-target="document" scroll-offset="200">
          <template>
            <div id="mobileDirectory" even$="[[_isEven(index)]]" staff$="[[item.audience]]">
              <div class="title service-title" hidden$="[[item.siteLink]]">[[item.title]]</div>
              <div class="title service-title" hidden$="[[!item.siteLink]]"><a href="[[item.siteLink]]">[[item.title]]</a></div>
              <div class="description service-description" hidden$="[[!item.body]]" inner-h-t-m-l="[[item.body]]"></div>
              <div hidden$="[[!_getLibs(item.library,smallScreen)]]">
                <div class="title-text">Location</div>
                <div class="location" inner-h-t-m-l="[[_getLibs(item.library)]]"></div>
              </div>
              <div hidden$=[[!_mobileContact(item.emailAddress,item.phoneNumber,item.formLink)]]>
                <div class="title-text">Contact</div>
                <div class="email" hidden$="[[!item.emailAddress]]"><a href="mailto:[[item.emailAddress]]">[[item.emailAddress]]</a></div>
                <div class="phone" hidden$="[[!item.phoneNumber]]"><a href="tel:[[item.phoneNumber]]">[[item.phoneNumber]]</a></div>
                <div class="form" hidden$="[[!item.formLink]]"><a href="[[item.formLink]]">Contact form</a></div>
              </div>
              <span hidden$="[[!item.audience]]" staff-text$="[[item.audience]]">staff info</span>
            </div>
          </template>
        </iron-list>
      </template>
    </div>
  </template>

  <script>
    let uvalibServicesTemplate;

    /**
     * `uvalib-services`
     * UVA Library page layout component
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvalibServices extends UvalibDirectory {
      static get is() { return 'uvalib-services'; }
      static get properties() {
        return Object.assign(super.properties,
            {
              _staffmember: {
                type: Boolean,
                value: false,
                observer: "_staffmemberChange"
              },
              _staffView: {
                type: Boolean,
                value: false,
                notify: true,
                observer: "_filterRows"
              },
              _data: {
                type: Array,
                value: function(){ return []; },
                notify: true
              },
              _sortDir: {
                type: String,
                value: "desc",
                observer: "_sortChange"
              }
            });
      }
      static get template() {
        if (!uvalibServicesTemplate) {
            // Retrieve this element's dom-module template
            uvalibServicesTemplate = Polymer.DomModule.import(this.is, 'template');
            // Clone the contents of the superclass template
            let superTemplateContents = document.importNode(UvalibDirectory.template.content, true);
            // Insert the superclass contents
            uvalibServicesTemplate.content.insertBefore(superTemplateContents,null);
        }
        return uvalibServicesTemplate;
      }
      _staffmemberChange() {
        if (this._staffmember) this._staffView = true;
      }
      _signIn() {
        this.shadowRoot.getElementById('accountuser').signInWithNetbadge();
      }
      _signOut() {
        this.shadowRoot.getElementById('accountuser').signOut();
        this._staffView = false;
      }

      _servicesChanged(){this._filterRows();}
      _filterRows() {
        //clone the pristine services listing so that we can come back from filters w/o reloading
        if (this._libraries && this._libraries.length > 0 && this._services){
          var data = JSON.parse(JSON.stringify(this._services));
          this._sortData(this._filterData(data));
        } else {
          setTimeout(function(){this._filterRows()}.bind(this),500);
        }
      }

      _filterData(data){
        if (this._query) {
          data = data.filter( this._filter(this._query) );
        }
        if (!this._staffView) {
          return data.filter( (s)=>(!s.audience || s.audience != "staff") );
        } else {
          return data;
        }
      }
      _sortChange(){
        if(this._data) {
          this._sortData( JSON.parse(JSON.stringify(this._data)) );
        }
      }
      _sortData(data){
        var dir = this._sortDir;
//        console.log(dir);
        if(data) {
          data.sort(function(a,b){
            if (dir === "desc") {
              return a.title.toLowerCase().localeCompare(b.title.toLowerCase());
            } else {
              return b.title.toLowerCase().localeCompare(a.title.toLowerCase());
            }
          });
          this.set('_data', data );
        }
      }
      _getLibs(libs){
        if (!libs) {
          return (this.smallScreen)? "":"&mdash;";
        } else {
//          if (!this._libs && this.$.libs) {
//            this._libs = this.$.libs.getHash('id',['title']);
//          }
          if (!this._libs && this.shadowRoot.querySelector('uva-library')) {
            this._libs = this.shadowRoot.querySelector('uva-library').getHash('id',['title']);
          }
          if (Object.keys(this._libs).length > 0) {
            libs = Array.isArray(libs)?libs:[libs];
            return '<ul class="services-location"><li>'+libs.map(function(a){return (this._libs[a.id])? this._libs[a.id].title: null;}.bind(this)).sort().join('</li><li>')+'</li></ul>';
          }
          return "";
        }
      }
      _filter(query){
        if (!query) {
          return null;
        } else {
          query = query.toLowerCase().trim().replace(/ +(?= )/g,'');
          return function(s) {
            var title = s.title.toLowerCase();
            var loc = this._getLibs(s.library).toLowerCase();
            return (title.indexOf(query) != -1 || loc.indexOf(query) != -1);
          }.bind(this);
        }
      }
      _getPersonName(uuid){
        if (this._people && uuid) {
          var person = this._people.find( person => person.uuid === uuid);
          if (person) return person.displayName;
        }
      }
      _getTeamName(uuid){
        if (this._teams && uuid) {
          var team = this._teams.find( team => team.uuid === uuid);
          if (team) return team.title;
        }
      }
      _isEven(n) {
        n = Number(n);
        return n === 0 || !!(n && !(n%2));
      }
      _mobileContact(emailAddress,phoneNumber,formLink) {
        return emailAddress || phoneNumber || formLink;
      }
    }

    window.customElements.define(UvalibServices.is, UvalibServices);
  </script>
</dom-module>
