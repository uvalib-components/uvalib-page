<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../uvalib-footer/uvalib-footer.html" >
<link rel="import" href="../uvalib-analytics/uvalib-analytics.html">
<link rel="import" href="../uvalib-header/uvalib-header.html">
<link rel="import" href="../uvalib-logos/uvalib-logo.html">
<link rel="import" href="../uvalib-nav/uvalib-nav.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../uvalib-theme/uvalib-theme.html">
<link rel="import" href="../app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../app-layout/app-toolbar/app-toolbar.html">
<!--
<link rel="import" href="../uvalib-alerts/uvalib-alerts.html">
-->

<!--
`uvalib-page`
Library Web Page template

@demo demo/index.html
-->

<dom-module id="uvalib-page">
  <template>
    <style is="custom-style" include="uvalib-theme">
      :host {
        display: block;
      }

      uvalib-header {
        z-index: 1000
      }
      app-toolbar {
        width: 256px;
        height: 110px;
        padding: 20px 0px 0px 0px;

        background-color: var(--color-primary-blue);
      }
      uvalib-logo {
        width: 235px;
        height: 110px;
        margin: 10px;
      }
      app-drawer {
        z-index: 1500
      }
      .content-holder {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);

        background-color: var(--color-white);
        position: relative;
        top: 118px;
      }
      .content {
        max-width: 1200px;
      }
      uvalib-footer {
        position: relative;
        top: 118px;
      }
    </style>

    <iron-media-query query="(max-width: 600px)" query-matches="{{smallScreen}}"></iron-media-query>
    <iron-media-query query="(min-width: 600px) and (max-width: 992px)" query-matches="{{mediumScreen}}"></iron-media-query>
    <iron-media-query query="(min-width: 993px)" query-matches="{{largeScreen}}"></iron-media-query>

    <template is="dom-if" if="{{!_hasCustomHeader()}}">
      <uvalib-header screen-size="{{screenSize}}" navigation="{{navigation}}" on-open-drawer="_toggleDrawer" content-has-search-box="{{contentHasSearchBox}}"></uvalib-header>
    </template>
    <content select="[header]"></content>

    <!-- Lazy-create the drawer for small screen sizes. -->
      <!-- Two-way bind `drawerOpened` since app-drawer can update `opened` itself. -->
      <app-drawer id="sidenav" swipe-open tabindex="0">
        <app-toolbar>
          <uvalib-logo stacked reverse two-color></uvalib-logo>
        </app-toolbar>
        <uvalib-nav stacked navigation="{{mobileNavigation}}"></uvalib-nav>
      </app-drawer>

    <div class="content-holder">
      <div class="content"><content></content></div>
    </div>

    <template is="dom-if" if="{{!_hasCustomFooter()}}">
      <uvalib-footer></uvalib-footer>
    </template>
    <content select="[footer]"></content>

    <!-- Library Site Analytics -->
    <uvalib-analytics site-id="10"></uvalib-analytics>
  </template>

  <script>
    Polymer({

      is: 'uvalib-page',

      properties: {
        /**
         * Array of JSON items that represent the navigation. Each JSON item has a label property, an icon property, and a url property.
         */
        navigation: {
          type: Array,
          value: [
            {"label": "About", "icon": "university", "url": "/about-uva-library/"},
            {"label": "Research", "icon": "graduation-cap", "url": "/research/"},
            {"label": "Collections", "icon": "book", "url": "/collections/"},
            {"label": "Services", "icon": "cloud", "url": "/services/"}
          ],
        },
        mobileNavigation: {
          type: Array,
          value: [
            {"label": "About", "icon": "university", "url": "/about-uva-library/"},
            {"label": "Research", "icon": "graduation-cap", "url": "/research/"},
            {"label": "Collections", "icon": "book", "url": "/collections/"},
            {"label": "Services", "icon": "cloud", "url": "/services/"},
            {"label": "Ask A Librarian", "icon": "comments", "url": "/askalibrarian/"}
          ],
        },
        contentHasSearchBox: {
          type: Boolean,
          value: false
        },
        mainContent: {
          type: String,
          value: "content"
        },
        smallScreen: {
          type: Boolean,
          notify: true,
          value: false,
          reflectToAttribute: true
        },
        mediumScreen: {
          type: Boolean,
          notify: true,
          value: false,
          reflectToAttribute: true
        },
        largeScreen: {
          type: Boolean,
          notify: true,
          value: false,
          reflectToAttribute: true
        },
        screenSize: {
          type: String,
          value: 'large',
          notify: true,
          readOnly: true,
          reflectToAttribute: true
        },
      },
      listeners: {
        'skiptocontent': '_changeFocusTo'
      },
      observers: [
        '_updateScreenSize(smallScreen,mediumScreen)'
      ],
      _toggleDrawer: function() {
        this.$.sidenav.toggle();
      },
      _updateScreenSize: function() {
        this._setScreenSize(
          (this.smallScreen)?'small':
                              (this.mediumScreen)?'medium':
                                                   'large'
        );
      },
      _changeFocusTo: function() {
        this.querySelector(this.mainContent).tabIndex = "-1";
        // reduce y position of scroll to account for sticky header so content does not roll up behind it
        window.scrollTo(0,findPos(document.getElementById(this.mainContent.split('#')[1])) - 110);
        this.querySelector(this.mainContent).focus();
      },
      _hasCustomHeader: function(){
        for (var i=0; i<Polymer.dom(this).children.length; i++) {
          if (Polymer.dom(this).children[i].hasAttribute('header'))
            return true;
        }
        return false;
      },
      _hasCustomFooter: function(){
        for (var i=0; i<Polymer.dom(this).children.length; i++) {
          if (Polymer.dom(this).children[i].hasAttribute('footer'))
            return true;
        }
        return false;
      }

    });

    // http://stackoverflow.com/questions/5007530/how-do-i-scroll-to-an-element-using-javascript
    // Finds y value of given object
    function findPos(obj) {
      var curtop = 0;
      if (obj.offsetParent) {
        do {
          curtop += obj.offsetTop;
        } while (obj = obj.offsetParent);
        return [curtop];
      }
    }
  </script>
</dom-module>
