<link rel="import" href="../uvalib-theme/uvalib-ui-element.html">
<link rel="import" href="../uvalib-theme/uvalib-theme.html">
<link rel="import" href="../uva-models/uva-library.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">

<dom-module id="uvalib-directorypage">
  <template>
  <custom-style>
      <style include="uvalib-theme uvalib-hourspage-style iron-flex-factors">
        :host {
          display: block;
        }
        .wrapper .row  {
          padding:10px;
          display: -ms-grid;
          display: grid;
          -ms-grid-columns: 1fr 1fr 1fr 1fr;
          grid-template-columns: repeat(4, 1fr);
          grid-gap: 10px;
        }
        span {
          display: inline-block;
        }
        .columnheader {
          font-weight: bold;
        }
        [role='button'] {
          cursor: pointer;
        }
        [stripe] {
          background-color: var(--uvalib-secondary-light-gray,#f2f2f2);
        }
        .header .row {
          border-bottom: solid;
          margin-bottom: 10px;
        }
      </style>
    </custom-style>

    <uva-library last-response="{{_libraries}}"></uva-library>
    <uva-library path="people" last-response="{{_people}}"></uva-library>
    <uva-library path="teams" last-response="{{_teams}}"></uva-library>
<!--    <uva-library path="areas" last-response="{{_areas}}"></uva-library> -->

    <div class="wrapper">
      <div class="header" aria-hidden="true">
         <div class="row">
           <span style="-ms-grid-column:1" class="columnheader"><a role="button" on-tap="_toggleOrder" href="" aria-label="Toggle Sort of listed Library staff by last name">Name <iron-icon icon="[[_toggleIcon(nameSortReverseOrder)]]"></iron-icon></a></span>
           <span style="-ms-grid-column:2" class="columnheader">Title</span>
           <span style="-ms-grid-column:3" class="columnheader">Department</span>
           <span style="-ms-grid-column:4" class="columnheader">Contact</span>
         </div>
       </div>
       <div role="rowgroup">
        <iron-list mutable-data items="[[_computePeople(_people,nameSortReverseOrder)]]" as="person" scroll-target="document" scroll-offset="200">
          <template>
            <div tabindex$="[[tabIndex]]" class="row" id$="[[person.id]]" stripe$="[[_isOdd(index)]]">
               <span aria-label="Name" style="-ms-grid-column:1" class="cell">[[person.displayName]]</span>
               <span aria-label="Title" style="-ms-grid-column:2" class="cell">[[person.jobTitle]]</span>
               <span aria-label="Teams" style="-ms-grid-column:3" class="cell">[[_formatTeams(person.teams,_teams,_teamsHashed)]]</span>
               <span aria-label="Contact" style="-ms-grid-column:4" class="cell">
                 <a aria-label="phone" href="tel:[[person.phone]]" hidden$="[[!person.phone]]">[[person.phone]]</a>
                 <br hidden$="[[!_and(person.phone,person.email)]]" />
                 <a aria-label="email" href="" hidden$="[[!person.email]]">[[person.email]]</a>
               </span>
            </div>
          </template>
        </iron-list>
      </div>
    </div>

  </template>

  <script>
    let uvalibDirectoryTemplate;

    /**
     * `uvalib-hourspage`
     * UVA Library page layout component
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvalibDirectorypage extends Polymer.GestureEventListeners(UvalibUiElement) {
      static get is() { return 'uvalib-directorypage'; }
      static get properties() {
        return Object.assign(super.properties,{
          _libraries: Array,
          _people: Array,
          _teams: Array,
          _teamsHashed: {
            type: Object,
            computed: '_computeHash(_teams)'
          },
          _areas: Array,
          peopleCount: {
            type: Number,
            computed: '_countPeople(_people)',
            notify: true
          },
          nameSortReverseOrder: {
            type: Boolean,
            value: false
          }
        });
      }
      static get template() {
        if (!uvalibDirectoryTemplate) {
            // Retrieve this element's dom-module template
            uvalibDirectoryTemplate = Polymer.DomModule.import(this.is, 'template');
            // Clone the contents of the superclass template
            let superTemplateContents = UvalibUiElement.template.content.cloneNode(true);
            // Insert the superclass contents
            uvalibDirectoryTemplate.content.insertBefore(superTemplateContents,null);
        }
        return uvalibDirectoryTemplate;
      }
      _computePeople(_people,revorder) {
        return _people?
          _people.sort(function(a, b) {
            var nameA = a.lastName.toUpperCase(); // ignore upper and lowercase
            var nameB = b.lastName.toUpperCase(); // ignore upper and lowercase
            if (nameA < nameB) return (revorder)? 1:-1;
            if (nameA > nameB) return (revorder)? -1:1;
            return 0;
          }):null;
      }
      _countPeople(_people) {
        return (_people && _people.length>0)? _people.length + 1: 0;
      }
      _sortOrder(nameSortReverseOrder) {
        return nameSortReverseOrder? "descending":"ascending"
      }
      _toggleOrder(e){
        e.preventDefault();
        this.nameSortReverseOrder = !this.nameSortReverseOrder;
      }
      _toggleIcon(nameSortReverseOrder){
        return nameSortReverseOrder? "caret-up":"caret-down";
      }
      _formatTeams(teams){
        return (Array.isArray(teams))?
          teams.map(t=>{
            return this._teamsHashed[t].title;
          }).join('<br />')
          :'';
      }
      _computeHash(arry){
        return (Array.isArray(arry))?
            arry.reduce((obj,item)=>{
              obj[item.uuid] = item;
              return obj;
            }, {}):{};
      }
    }

    window.customElements.define(UvalibDirectorypage.is, UvalibDirectorypage);
  </script>
</dom-module>
